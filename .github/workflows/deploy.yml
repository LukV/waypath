name: Release & Deploy

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write  # Needed to push changelog and tags

jobs:
  release-and-deploy:
    runs-on: ubuntu-latest

    env:
      ACR_NAME: waypathacrdev
      IMAGE_NAME: waypath
      RESOURCE_GROUP: rg-waypath-dev
      CONTAINER_APP: waypath-api-dev

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for tagging

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: poetry

      - name: ğŸ“¦ Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ğŸ“¥ Install dependencies (dev)
        run: poetry install

      - name: âœ… Lint & Typecheck
        run: |
          poetry run ruff check .
          poetry run mypy .

      - name: ğŸ§¾ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“ Generate changelog
        run: poetry run cz changelog

      - name: ğŸ”¢ Bump version
        run: poetry run cz bump --yes

      - name: ğŸš€ Push version & changelog
        run: git push --follow-tags origin main

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ” Azure Container Registry Login
        run: az acr login --name $ACR_NAME

      - name: ğŸ³ Build & Push Docker Image
        run: |
          docker buildx create --use
          docker buildx build \
            --platform linux/amd64 \
            -t $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }} \
            -t $ACR_NAME.azurecr.io/$IMAGE_NAME:latest \
            . --push

      - name: ğŸ”„ Restart Container App with SHA image
        run: |
          az containerapp update \
            --name $CONTAINER_APP \
            --resource-group $RESOURCE_GROUP \
            --image $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}